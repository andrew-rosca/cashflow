# CashFlow Development Progress

## Project Overview

CashFlow is a personal finance application that helps users project future account balances based on expected inflows and outflows. The primary goal is to ensure users never run out of money by visualizing when balances might approach or drop below zero.

**Key Capabilities:**
- Double-entry transaction tracking
- Recurring transaction patterns (daily, weekly, bi-weekly, monthly, yearly)
- Balance projections with danger zone highlighting
- Multi-account tracking (tracked accounts + external categories)
- Settlement lag support for transfers
- API-first architecture

## Architecture Decisions

### Technology Stack

**Frontend:**
- Next.js 14 (App Router) - Modern React framework with built-in API routes
- TypeScript - Type safety throughout the application
- Tailwind CSS - Utility-first styling
- Recharts - Data visualization for balance projection graphs

**Backend:**
- Next.js API Routes - Serverless API endpoints
- NextAuth.js - Authentication (Apple/Google Sign-In)
- Prisma ORM - Type-safe database access
- PostgreSQL - Production database

**Deployment:**
- Vercel - Zero-config deployment for Next.js
- Vercel Postgres or Supabase - Managed PostgreSQL options

### Key Design Patterns

#### 1. Data Adapter Pattern
All data access goes through the `DataAdapter` interface (`src/lib/data-adapter.ts`). This abstraction allows:
- Swapping storage backends without changing business logic
- Testing with mock adapters
- Future support for multiple storage options (MongoDB, SQLite, in-memory)

The reference implementation is `PrismaDataAdapter` (`src/lib/prisma-adapter.ts`).

#### 2. Double-Entry Accounting
Every transaction has:
- `fromAccountId` (debit) - where money leaves
- `toAccountId` (credit) - where money arrives

This enables:
- Accurate tracking of money flow
- Income/expense reporting by external account
- Cash flow statements
- Net worth calculation

Transaction types:
| From | To | Name |
|------|-----|------|
| External (Income) | Tracked Account | Inflow |
| Tracked Account | External (Expense) | Outflow |
| Tracked Account | Tracked Account | Transfer |

#### 3. Account Types
- **Tracked accounts**: Real accounts the user monitors (checking, savings, credit cards)
  - Have `initialBalance`
  - Included in projections
  - Future: sync with Plaid

- **External accounts**: Categories for income/expenses
  - Optional `category` field
  - Used for reporting and organization
  - Not included in projections

#### 4. Recurrence Patterns
Transactions can recur with flexible patterns:
- `frequency`: daily, weekly, biweekly, monthly, yearly
- `interval`: every N periods (e.g., every 2 weeks)
- `dayOfWeek`: for weekly (0-6)
- `dayOfMonth`: for monthly (1-31)
- `endDate`: optional end date
- `occurrences`: optional limit on number of occurrences

The projection engine materializes recurring transactions into specific dates.

#### 5. Settlement Lag
For transfers between tracked accounts, `settlementDays` specifies the delay between debit and credit:
- Debit happens on `date`
- Credit happens on `date + settlementDays`

This models real-world scenarios like ACH transfers or check deposits.

### Database Schema

**User Management (NextAuth.js):**
- `User` - User profiles
- `Account` - OAuth provider accounts
- `Session` - Active sessions
- `VerificationToken` - Email verification

**CashFlow Domain:**
- `CashFlowAccount` - User accounts (tracked/external)
- `Transaction` - Financial transactions
- `Recurrence` - Recurring transaction patterns

Key relationships:
- User → CashFlowAccount (one-to-many)
- User → Transaction (one-to-many)
- CashFlowAccount → Transaction (one-to-many for both from and to)
- Transaction → Recurrence (one-to-one, optional)

### API Design

RESTful API following standard conventions:

**Accounts:**
- `GET /api/accounts` - List (filterable by type)
- `POST /api/accounts` - Create
- `GET /api/accounts/:id` - Get one
- `PUT /api/accounts/:id` - Update
- `DELETE /api/accounts/:id` - Delete

**Transactions:**
- `GET /api/transactions` - List (filterable by account, date range, recurring)
- `POST /api/transactions` - Create
- `GET /api/transactions/:id` - Get one
- `PUT /api/transactions/:id` - Update
- `DELETE /api/transactions/:id` - Delete

**Projections:**
- `GET /api/projections` - Calculate (query: accountId, startDate, endDate)

All endpoints:
- Return JSON
- Use standard HTTP status codes (200, 201, 204, 400, 404, 500)
- Include user authentication (to be implemented)
- Enforce data isolation (users only access their own data)

### UI Components (To Be Built)

1. **Dashboard** - Main view with:
   - Balance projection graph (line chart)
   - Upcoming calendar (next 30-60 days)
   - Account filter dropdown
   - Danger zone highlights

2. **Accounts Page** - Account management:
   - List of tracked accounts with balances
   - List of external accounts with categories
   - Create/edit/delete forms
   - Inline creation during transaction entry

3. **Transactions Page** - Transaction management:
   - Tabs: One-time vs Recurring
   - List with from/to accounts, amount, date/pattern
   - Create/edit/delete forms
   - Recurrence pattern builder
   - Search/filter/sort

4. **Reports** (Future) - Analytics:
   - Income/expense by category
   - Cash flow statement
   - Budget tracking

### Security Considerations

1. **Authentication**: NextAuth.js with Apple/Google Sign-In
2. **Authorization**: User ID from session enforced in all API routes
3. **Data Isolation**: All queries filter by `userId`
4. **Input Validation**: Zod schemas for request validation (to be added)
5. **SQL Injection**: Protected by Prisma's parameterized queries
6. **XSS**: React's automatic escaping + Content Security Policy (to be added)

### Future Enhancements

1. **Plaid Integration**:
   - Define `IntegrationAdapter` interface
   - Auto-sync account balances
   - Import transactions
   - Map to double-entry format

2. **Advanced Reporting**:
   - Income/expense by category
   - Cash flow statement
   - Budget tracking vs actuals

3. **Multi-User Features**:
   - Shared accounts/households
   - Permissions (view vs edit)

4. **Mobile App**:
   - React Native or Flutter
   - Same API backend
   - Offline-first with sync

5. **Additional Features**:
   - Multiple currencies
   - Transaction reconciliation
   - Scheduled reports
   - What-if scenarios

## Session Log

### Session 1 - Initial Project Setup (December 20, 2025)

**Status**: Scaffolding complete, ready for feature implementation

**Created Files:**
- `package.json` - Project dependencies and scripts
- `tsconfig.json` - TypeScript configuration
- `next.config.js`, `tailwind.config.js`, `postcss.config.js` - Framework configs
- `.gitignore` - Ignore node_modules, .env, build artifacts
- `.env.example` - Environment variable template
- `prisma/schema.prisma` - Complete database schema
- `src/lib/db.ts` - Prisma client singleton
- `src/lib/data-adapter.ts` - Data adapter interface
- `src/lib/prisma-adapter.ts` - Prisma adapter implementation
- `src/app/layout.tsx`, `src/app/page.tsx`, `src/app/globals.css` - Basic UI structure
- `src/app/api/accounts/route.ts` - Account CRUD API
- `src/app/api/accounts/[id]/route.ts` - Single account API
- `src/app/api/transactions/route.ts` - Transaction CRUD API
- `src/app/api/transactions/[id]/route.ts` - Single transaction API
- `src/app/api/projections/route.ts` - Projection calculation API (stub)
- `init.sh` - Setup and development start script
- `docs/feature_list.json` - 83 features defined across 17 priority levels
- `docs/specification.md` - Complete project requirements
- `docs/coder-instructions.md` - Guidelines for coding sessions
- `docs/initializer-instructions.md` - Setup guidelines
- `docs/implementation-progress.txt` - This file
- `README.md` - Project documentation

**Architecture Decisions:**
1. Chose Next.js for unified frontend/backend
2. PostgreSQL + Prisma for reliable, type-safe data access
3. Data adapter pattern for storage flexibility
4. Double-entry model for comprehensive financial tracking
5. API-first design for future mobile clients
6. Vercel deployment for simplicity

**What Works:**
- Project structure is complete
- API routes are defined (data layer stubbed out)
- Database schema includes all required entities
- Setup script will install dependencies and start dev server

**What Needs Work:**
- Authentication (NextAuth.js setup)
- Projection calculation engine (materialize recurring, calculate balances)
- UI components (dashboard, forms, lists, graphs)
- Input validation (Zod schemas)
- Error handling and user feedback
- Testing setup

**Next Steps for Coding Agent:**

1. **First Session**: Verify basic setup
   - Run `./init.sh`
   - Confirm database connects
   - Test account API endpoints with curl/Postman
   - Mark F001 (database setup) as complete

2. **Early Features** (F002-F007): Account CRUD
   - These API routes are defined but need testing
   - May need minor fixes in adapter implementation
   - Should be quick wins

3. **Transaction Features** (F008-F013): Transaction CRUD
   - Similar to accounts, mostly implemented
   - Need to verify recurrence pattern handling

4. **Core Logic** (F014-F018): Projection Engine
   - Most complex part of the application
   - Requires algorithm to:
     - Materialize recurring transactions into specific dates
     - Calculate daily balances from initial balance + transactions
     - Identify dates where balance <= 0
   - This is the heart of the application

5. **UI Development** (F019+): User Interface
   - Build React components using Tailwind
   - Integrate with API
   - Add charts with Recharts
   - Implement forms and validation

**Recommended Order:**
1. F001: Verify setup ← START HERE
2. F002-F007: Account APIs ← Quick wins
3. F008-F013: Transaction APIs ← Quick wins
4. F015-F018: Projection engine ← Core functionality
5. F019-F034: UI components ← User-facing features
6. F035-F038: Authentication ← Security
7. F039-F070: Polish (responsive, accessibility, UX)
8. F071-F073: Deployment ← Go live
9. F074-F083: Future enhancements ← Post-MVP

---

## Development Guidelines

When working on features:

1. **One feature at a time** - Focus on completing F001, then F002, etc.
2. **Test end-to-end** - Use curl/Postman for API, browser for UI
3. **Mark complete only after testing** - Change `"passes": false` to `"passes": true`
4. **Commit after each feature** - Clear commit messages
5. **Update this file** - Log decisions, issues, progress
6. **Leave it working** - Every session should end with a runnable app

Current feature status: 13/83 complete (15.7%)

---

## Session Log

### Session 2 - API Implementation & Testing (December 20, 2025)

**Status**: Core API features complete with automated tests

**Completed Features:**
- ✅ F001: Database connection and Prisma client setup (SQLite)
- ✅ F002: Create tracked account via API
- ✅ F003: Create external account via API
- ✅ F004: List accounts with filtering (tracked/external)
- ✅ F005: Get single account by ID
- ✅ F006: Update account via API
- ✅ F007: Delete account via API
- ✅ F008: Create one-time transaction via API
- ✅ F009: Create recurring transaction via API
- ✅ F010: List transactions with filtering (by account, date range)
- ✅ F011: Get single transaction by ID
- ✅ F012: Update transaction via API
- ✅ F013: Delete transaction via API

**Changes Made:**

1. **Switched to SQLite for local development**
   - Updated `prisma/schema.prisma` to use SQLite datasource
   - Removed PostgreSQL-specific `@db.Text` annotations
   - Updated `.env` and `.env.example` with SQLite connection string
   - Benefits: No database server setup required, easier local development

2. **Fixed Prisma Schema**
   - Added missing `cashFlowAccounts` relation field on `User` model
   - Fixed foreign key constraint errors

3. **Fixed API Response Issues**
   - DELETE endpoints now return `new NextResponse(null, { status: 204 })` instead of JSON
   - Fixed "Invalid response status code 204" error in both accounts and transactions endpoints

4. **Created Test User Seed Script**
   - Added `scripts/seed-user.js` to create stub user "user-1"
   - Required for foreign key constraints to work with stub auth

5. **Added Automated Testing**
   - Installed Vitest testing framework
   - Created `tests/api/accounts.test.ts` with 9 tests for F002-F007
   - Created `tests/api/transactions.test.ts` with 8 tests for F008-F013
   - All 17 tests passing ✅
   - Added `npm test` and `npm test:watch` scripts

**Testing Coverage:**
- Account creation (tracked and external types)
- Account listing and filtering
- Account retrieval, update, and deletion
- Transaction creation (one-time and recurring)
- Transaction listing and filtering
- Transaction retrieval, update, and deletion
- Error cases (404 for non-existent resources)

**What Works:**
- All Account CRUD operations (create, read, update, delete)
- Account filtering by type (tracked/external)
- All Transaction CRUD operations with recurrence patterns
- Transaction filtering by account ID
- Database schema and migrations
- Development server runs successfully
- Automated test suite validates all API functionality

**Known Issues/Limitations:**
- Still using stub user ID ("user-1") - authentication not yet implemented
- User isolation not enforced (would need proper auth first)
- F014 (settlement lag) not yet implemented
- Projection engine (F015-F018) not yet implemented

**Next Steps:**
1. Implement settlement lag for transfers (F014)
2. Build projection engine (F015-F018) - most complex feature
3. Build UI components (F019+)
4. Add proper authentication (F035-F038)

---

### Session 3 - Settlement Lag Implementation (December 20, 2025)

**Status**: Settlement lag feature complete with tests

**Completed Features:**
- ✅ F014: Transaction with settlement lag between tracked accounts

**Changes Made:**

1. **Created Settlement Lag Test Suite**
   - Added `tests/api/settlement-lag.test.ts` with 5 comprehensive tests
   - Tests cover:
     - Creating transactions with settlementDays > 0
     - Retrieving transactions with settlement lag
     - Updating settlementDays on existing transactions
     - Handling transactions with no settlement lag (undefined)
     - Handling zero settlementDays (instant settlement)

2. **Verified Existing Implementation**
   - Confirmed `settlementDays` field exists in Prisma schema (Transaction model, line 85)
   - Confirmed API routes already support passing settlementDays
   - Confirmed PrismaDataAdapter properly handles settlementDays in CRUD operations

**Testing Coverage:**
- All 22 tests passing (17 existing + 5 new settlement lag tests)
- Settlement lag can be set, retrieved, and updated
- Supports integer values (0, 3, 5, etc.) and undefined (no lag)

**What Works:**
- Creating transfers with settlement lag between tracked accounts
- Storing and retrieving settlementDays value
- Updating settlement lag on existing transactions
- The field is properly optional (can be undefined or 0 for instant transfers)

**Next Steps:**
1. Implement projection engine (F015-F018) - this is where settlement lag will be used
   - F015: Calculate daily balances for tracked accounts
   - F016: Materialize recurring transactions
   - F017: Handle recurring with end date/occurrences
   - F018: Identify dates where balance <= 0
   - Settlement lag will affect when debits and credits appear in projections

**Notes:**
- Settlement lag functionality is complete at the data layer
- The projection engine will use settlementDays to split transfers into separate debit/credit events
- Debit will occur on `date`, credit will occur on `date + settlementDays`

---

### Session 4 - Basic UI Implementation (December 20, 2025)

**Status**: Basic UI complete - app is now usable

**Completed Features:**
- ✅ F019: Account management page displays tracked and external accounts
- ✅ F020: Create new account via UI form
- ✅ F021: Edit existing account via UI
- ✅ F022: Delete account via UI with confirmation
- ✅ F023: One-time transaction list view
- ✅ F024: Recurring transaction list view
- ✅ F025: Create one-time transaction via UI form
- ✅ F026: Create recurring transaction via UI form
- ✅ F028: Edit transaction via UI
- ✅ F029: Delete transaction via UI with confirmation

**Changes Made:**

1. **Created Main Application UI**
   - Updated `src/app/page.tsx` with tabbed interface
   - Two main tabs: Accounts and Transactions
   - Clean, modern design with Tailwind CSS
   - Dark mode support

2. **Created AccountsTab Component** (`src/components/AccountsTab.tsx`)
   - Displays tracked and external accounts in separate sections
   - Create account form with type-specific fields
   - Edit and delete functionality with confirmation
   - Real-time updates via API integration

3. **Created TransactionsTab Component** (`src/components/TransactionsTab.tsx`)
   - Tabbed view for one-time vs recurring transactions
   - Comprehensive transaction form with all fields
   - Settlement lag support in UI
   - Recurring transaction pattern builder
   - Edit and delete functionality with confirmation

**What Works:**
- Full CRUD for accounts (create, read, update, delete)
- Full CRUD for transactions (create, read, update, delete)
- Settlement lag field integrated in transaction form
- Recurring transaction creation with frequency options
- Separate lists for one-time and recurring transactions
- Account selection dropdowns in transaction form
- Responsive design with dark mode
- App is now fully usable at http://localhost:3001

**Not Yet Implemented:**
- F027: Inline account creation during transaction entry
- Projection engine and dashboard visualization
- Advanced UI features (search, filters, pagination)
- Authentication

**Next Steps:**
1. Build projection engine (F015-F018) - core calculation logic
2. Add dashboard with balance projection graph (F030-F033)
3. Add authentication (F035-F038)

---

## Notes

- Currently using stub user ID ("user-1") in API routes
- Need to implement real authentication before production
- Projection engine is the most complex feature - may need multiple sessions
- Automated tests will help catch regressions as we add features
- UI design can iterate - start simple, refine later

